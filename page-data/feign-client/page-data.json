{"componentChunkName":"component---src-templates-post-jsx","path":"/feign-client/","result":{"data":{"site":{"siteMetadata":{"title":"Seokho's Dev"}},"markdownRemark":{"id":"8f11182d-6515-5925-aa77-12b91f24423c","excerpt":"서론 현재 진행하고 있는 식당 리뷰 sns 프로젝트에서 유저 로그인 기능의 구현을 담당하고 있다. 카카오 로그인을 구현하던 중, 카카오에서 제공하는 api에 Http 요청을 보내기 위해서는 클라이언트 객체를 사용해야했고 흔히 알고 있는 RestTemplate과 WebClient를 후보에 두고 고민하고 있었다.\n그러던 중 쿠킴의 소개로 Feign Clien…","html":"<h2 id=\"서론\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%A1%A0\" aria-label=\"서론 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>서론</h2>\n<p>현재 진행하고 있는 <a href=\"https://github.com/jjik-muk/sikdorak\">식당 리뷰 sns 프로젝트</a>에서 유저 로그인 기능의 구현을 담당하고 있다.</p>\n<p>카카오 로그인을 구현하던 중, 카카오에서 제공하는 api에 Http 요청을 보내기 위해서는 클라이언트 객체를 사용해야했고 흔히 알고 있는 <strong>RestTemplate</strong>과 <strong>WebClient</strong>를 후보에 두고 고민하고 있었다.\n그러던 중 쿠킴의 소개로 <strong>Feign Client</strong>의 존재를 알게 되었다.</p>\n<img src='https://github.com/Seokho-Ham/seokho-ham.github.io/assets/57708971/8099416e-a8ab-4a7a-9dfa-fae7a93db4ac' width='400'>\n<hr>\n<h2 id=\"-Feign-Client란\" style=\"position:relative;\"><a href=\"#-Feign-Client%EB%9E%80\" aria-label=\" Feign Client란 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>💫 Feign Client란?</h2>\n<p>Feign Client란 Netflix에서 개발한 Http Client다.<br>\n(HttpClient는 Http 요청을 간편하게 만들어서 보낼 수 있도록 돕는 객체라고 생각하면 될것 같다.)<br>\n처음에는 Netflix에서 자체적으로 개발을 진행했지만 현재는 오픈소스로 전환했으며 SpringCloud 프레임워크의 프로젝트 중 하나로 들어가있다.</p>\n<h3 id=\"장점\" style=\"position:relative;\"><a href=\"#%EC%9E%A5%EC%A0%90\" aria-label=\"장점 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>장점</h3>\n<ul>\n<li>SpringMvc에서 제공되는 어노테이션을 그대로 사용할 수 있다. (Spring Cloud의 starter-openfeign을 사용할 경우)</li>\n<li>RestTemplate 보다 간편하게 사용할 수 있으며 가독성이 좋다.</li>\n<li>Feign Client를 사용한 통합 테스트가 비교적 간편하다.</li>\n<li>요청에 대한 커스텀이 간편하다.<br>\nex) 요청이 실패했을때 몇초 간격으로 몇번 재요청을 보낼것인지를 구체적으로 정할 수 있다.</li>\n</ul>\n<h3 id=\"단점\" style=\"position:relative;\"><a href=\"#%EB%8B%A8%EC%A0%90\" aria-label=\"단점 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>단점</h3>\n<ul>\n<li>동기적으로 동작한다. 즉, 하나의 요청이 끝나야 다음 동작이 가능하다.<br>\n(이건 비동기적으로 동작해야하는 경우 단점이 될 수 있을것 같다.)</li>\n</ul>\n<blockquote>\n<p><strong>우리 서비스에서는 사용자 로그인 API에서만 사용하기 때문에 비동기가 지원될 필요가 없다고 판단했고<br>\nFeign Client를 도입해보기로 결정했다.</strong></p>\n</blockquote>\n<hr>\n<h2 id=\"-프로젝트에-적용\" style=\"position:relative;\"><a href=\"#-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%97%90-%EC%A0%81%EC%9A%A9\" aria-label=\" 프로젝트에 적용 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>💫 프로젝트에 적용</h2>\n<p>FeignClient를 사용하기 위해 먼저 build.gradle에 관련 의존성을 추가했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//프로젝트에서 사용한 버전 정보</span>\nspring<span class=\"token operator\">-</span>boot <span class=\"token operator\">:</span> <span class=\"token number\">2.7</span><span class=\"token number\">.1</span>\nspring<span class=\"token operator\">-</span>cloud <span class=\"token operator\">:</span> <span class=\"token number\">2021.0</span><span class=\"token number\">.3</span>\nspring<span class=\"token operator\">-</span>cloud<span class=\"token operator\">-</span>openfeign <span class=\"token operator\">:</span> <span class=\"token number\">3.1</span><span class=\"token number\">.3</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">ext <span class=\"token punctuation\">{</span>\n\tspringCloudVersion <span class=\"token operator\">=</span> '<span class=\"token number\">2021.0</span><span class=\"token number\">.3</span>'\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//...</span>\n\ndependencyManagement <span class=\"token punctuation\">{</span>\n\timports <span class=\"token punctuation\">{</span>\n\t\tmavenBom <span class=\"token string\">\"org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}\"</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//...</span>\ndependencies <span class=\"token punctuation\">{</span>\n\timplementation 'org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cloud<span class=\"token operator\">:</span>spring<span class=\"token operator\">-</span>cloud<span class=\"token operator\">-</span>starter<span class=\"token operator\">-</span>openfeign'\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><strong>ext</strong> : gradle 내에서 사용할 변수를 설정할 수 있다. 여기서는 springCloudVersion을 변수로 관리하도록 했다.</li>\n<li><strong>dependencyManagement</strong> : 사용할 의존성의 버전을 명시해두면 dependencies에서 실제 의존성을 작성할때 버전을 따로 작성하지 않아도 위에 명시된 버전으로 가져온다.</li>\n</ul>\n<p>의존성을 가져온 뒤 Feign Client를 사용하여 API 호출을 담당할 클라이언트 인터페이스를 만들었다.<br>\n만드는 방법은 간단한데 클라이언트를 인터페이스로 만들고 내부에 호출할 메서드만 작성하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//FeignClient를 사용한 코드</span>\n\n<span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"oauth-token-client\"</span><span class=\"token punctuation\">,</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://oauth-server.com\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OAuthTokenClient</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/oauth/token\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token class-name\">OAuthTokenResponse</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">,</span>\n                                      <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">,</span>\n                                      <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">,</span>\n                                      <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><strong>@FeignClient</strong> : 앱이 런타임 시 해당 어노테이션이 붙은 인터페이스를 토대로 실제 구현체를 만든다.</p>\n<ul>\n<li>name : 실제 구현체가 Application Context에 빈으로 등록될때 이름으로 사용된다.</li>\n<li>url : 요청을 보낼 엔드포인트를 의미한다.</li>\n</ul>\n</li>\n<li><strong>@PostMapping</strong> : 해당 HttpMethod로 요청을 전송한다.</li>\n<li>\n<p><strong>@RequestParam</strong> : 요청 시 함께 보낼 파라미터들 설정한다.</p>\n<ul>\n<li>메서드의 파라미터에 @RequestParam, @RequestHeader 등의 어노테이션을 사용하지 않으면 기본적으로 요청의 Body에 파리미터의 값들이 들어간다.</li>\n</ul>\n</li>\n</ul>\n<p>코드를 작성하고나니 의문이 생겼다.</p>\n<blockquote>\n<p><strong>어떻게 SpringMvc의 어노테이션을 사용할 수 있는걸까?</strong></p>\n</blockquote>\n<p>찾아보니 FeignClient는 빈으로 생성될 때 설정된 configuration 을 읽어서 생성되는데 configuration 내부에는<br>\nClient 생성 시 사용할 Decoder, Encoder, Logger, Contract 등을 빈으로 등록하는 코드가 담겨있었다.</p>\n<p>이때 Client에 따로 Configuration 설정을 해주지 않으면 디폴트인 <strong>FeignClientsConfiguration</strong> 를 사용해서 생성하는데 default로 적용된 Contract는 SpringMvcContract였고 덕분에 SpringMvc의 어노테이션을 사용할 수 있었다.</p>\n<img src='https://github.com/Seokho-Ham/seokho-ham.github.io/assets/57708971/70687782-c66c-4412-80a9-e8b3126a1e45' width='1000'>\n<ul>\n<li>decoder, encoder, logger도 모두 Spring이 사용하는 객체들을 사용하도록 되어있다.</li>\n</ul>\n<img src='https://github.com/Seokho-Ham/seokho-ham.github.io/assets/57708971/317c2534-6f7c-46b2-9d71-53731eaed5bb' width='600'>\n<p>이후 서비스의 로직에서는 만든 클라이언트 객체를 빈으로 주입받아 사용했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuthTokenClient</span> oAuthTokenClient<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//...</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">JwtToken</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">OAuthTokenResponse</span> oAuthTokenResponse <span class=\"token operator\">=</span> <span class=\"token function\">getOAuthAccessToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OAuthTokenResponse</span> <span class=\"token function\">getOAuthAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> oAuthTokenClient<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>\n                oAuthProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getGrantType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                oAuthProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                oAuthProperties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>FeignClient는 SpringBootApplication이 실행될때 @FeignClient 어노테이션이 붙은 파일들을 읽어서 구현체를 만들기 때문에 앱 구동시 어노테이션을 읽을 수 있게 @EnableFeignClients 어노테이션을 붙여주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token annotation punctuation\">@EnableFeignClients</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Application</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아래는 위의 설정을 마치고 실제 OAuth 서버로 요청을 보냈을때의 요청/응답 로그다.<br>\n해당 로그가 출력되려면 프로젝트의 로깅 레벨은 DEBUG 로, FeignClient의 로깅 레벨은 FULL로 설정되어 있어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//application.yml</span>\nlogging<span class=\"token operator\">:</span>\n  level<span class=\"token operator\">:</span>\n    com<span class=\"token punctuation\">.</span>project<span class=\"token operator\">:</span> debug\n\nfeign<span class=\"token operator\">:</span>\n  client<span class=\"token operator\">:</span>\n    config<span class=\"token operator\">:</span>\n      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n        loggerLevel<span class=\"token operator\">:</span> <span class=\"token constant\">FULL</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">//요청</span>\n---> POST http<span class=\"token operator\">:</span><span class=\"token comment\">//oauth-server/oauth/token?grant_type=authorization_code&amp;client_id=1234&amp;redirect_uri=redirectUri&amp;code=code HTTP/1.1</span>\nContent-Type<span class=\"token operator\">:</span> application/x-www-form-urlencoded;charset=utf<span class=\"token number\">-8</span>\n---> END HTTP (<span class=\"token number\">0</span>-byte body)\n\n<span class=\"token comment\">// 응답</span>\n&lt;--- HTTP/<span class=\"token number\">1.1</span> <span class=\"token number\">200</span> OK (131ms)\naccess-control-allow-headers<span class=\"token operator\">:</span> Authorization<span class=\"token punctuation\">,</span> KA<span class=\"token punctuation\">,</span> Origin<span class=\"token punctuation\">,</span> X-Requested-With<span class=\"token punctuation\">,</span> Content-Type<span class=\"token punctuation\">,</span> Accept\naccess-control-allow-methods<span class=\"token operator\">:</span> GET<span class=\"token punctuation\">,</span> POST<span class=\"token punctuation\">,</span> OPTIONS\naccess-control-allow-origin<span class=\"token operator\">:</span> *\ncache-control<span class=\"token operator\">:</span> no-cache<span class=\"token punctuation\">,</span> no-store<span class=\"token punctuation\">,</span> max-age=<span class=\"token number\">0</span><span class=\"token punctuation\">,</span> must-revalidate\nconnection<span class=\"token operator\">:</span> keep-alive\ncontent-type<span class=\"token operator\">:</span> application/json;charset=utf<span class=\"token number\">-8</span>\ndate<span class=\"token operator\">:</span> Sat<span class=\"token punctuation\">,</span> <span class=\"token number\">13</span> Aug <span class=\"token number\">2022</span> <span class=\"token number\">02</span><span class=\"token operator\">:</span><span class=\"token number\">48</span><span class=\"token operator\">:</span><span class=\"token number\">13</span> GMT\nexpires<span class=\"token operator\">:</span> <span class=\"token number\">0</span>\ntransfer-encoding<span class=\"token operator\">:</span> chunked\nx-content-type-options<span class=\"token operator\">:</span> nosniff\nx-frame-options<span class=\"token operator\">:</span> DENY\nx-xss-protection<span class=\"token operator\">:</span> <span class=\"token number\">1</span>; mode=block\nresponse-body<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"token_type\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"bearer\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"access_token\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"accessToken\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"expires_in\"</span><span class=\"token operator\">:</span><span class=\"token number\">43199</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"refresh_token\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"refreshToken\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"refresh_token_expires_in\"</span><span class=\"token operator\">:</span><span class=\"token number\">25184000</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scope\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"account_email profile\"</span>\n<span class=\"token punctuation\">}</span>\n&lt;--- END HTTP (<span class=\"token number\">190</span>-byte body)</code></pre></div>\n<p>아래는 추가적으로 해준 설정들이다.</p>\n<h2 id=\"-커스텀한-Configuration-설정\" style=\"position:relative;\"><a href=\"#-%EC%BB%A4%EC%8A%A4%ED%85%80%ED%95%9C-Configuration-%EC%84%A4%EC%A0%95\" aria-label=\" 커스텀한 Configuration 설정 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>🛠 커스텀한 Configuration 설정</h2>\n<h3 id=\"1-공통-헤더적용을-위한-Configuration\" style=\"position:relative;\"><a href=\"#1-%EA%B3%B5%ED%86%B5-%ED%97%A4%EB%8D%94%EC%A0%81%EC%9A%A9%EC%9D%84-%EC%9C%84%ED%95%9C-Configuration\" aria-label=\"1 공통 헤더적용을 위한 Configuration permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>1. 공통 헤더적용을 위한 Configuration</h3>\n<ul>\n<li>요청에 content-type 헤더가 기본적으로 필요해서 configuration 파일을 만들었고 Client 객체에 적용했다.</li>\n<li>요청을 가로채서 헤더를 세팅하는 requestInterceptor를 빈으로 등록하면 된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FeignClientHeaderConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">APPLICATION_FORM_URLENCODED_UTF8_VALUE</span> <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED_VALUE</span> <span class=\"token operator\">+</span> <span class=\"token string\">\";charset=utf-8\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RequestInterceptor</span> <span class=\"token function\">requestInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> requestTemplate <span class=\"token operator\">-></span> requestTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONTENT_TYPE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">APPLICATION_FORM_URLENCODED_UTF8_VALUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"2-FeignClient-Exception을-서비스-예외로-처리하기-위한-Configuration\" style=\"position:relative;\"><a href=\"#2-FeignClient-Exception%EC%9D%84-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%98%88%EC%99%B8%EB%A1%9C-%EC%B2%98%EB%A6%AC%ED%95%98%EA%B8%B0-%EC%9C%84%ED%95%9C-Configuration\" aria-label=\"2 FeignClient Exception을 서비스 예외로 처리하기 위한 Configuration permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>2. FeignClient Exception을 서비스 예외로 처리하기 위한 Configuration</h3>\n<ul>\n<li>Feign Client를 통한 요청이 실패했을 경우 OAuthServer에서의 예외가 발생했다는 메세지를 사용자에게 전달하고 싶었고, 커스텀한 ErrorDecoder를 빈으로 등록하는 configuration을 Client 객체에 적용했다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FeignClientOAuthErrorConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ErrorDecoder</span> <span class=\"token function\">decoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>methodKey<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{} 요청이 성공하지 못했습니다. requestUrl: {}, requestBody: {}, responseBody: {}\"</span><span class=\"token punctuation\">,</span>\n                    methodKey<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">FeignClientResponseUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRequestBody</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">FeignClientResponseUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResponseBody</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthServerException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>위의 Configuration들을 적용한 코드</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//적용</span>\n<span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"oauth-token-client\"</span><span class=\"token punctuation\">,</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"oauth-server\"</span><span class=\"token punctuation\">,</span> configuration <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token class-name\">FeignClientHeaderConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">FeignClientOAuthErrorConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OAuthTokenClient</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이때 주의할 점으로는 configuration 파일에 <strong>@Configuration 어노테이션을 붙이는것을 지양</strong>해야한다.\n해당 어노테이션을 붙이게 되면 컴포넌트 스캔이 발생하는 시점에 빈으로 등록되어 모든 FeignClient에 적용된다.</p>\n<ul>\n<li>현재 서비스에서는 모든 요청에 대해 적용할 decoder라서 어노테이션을 붙일까 고민했지만 변경사항이 발생할 수 있기에 직접 configuration을 설정해줬다.</li>\n</ul>\n<h3 id=\"3-url을-applicationproperties에서-관리-후-적용\" style=\"position:relative;\"><a href=\"#3-url%EC%9D%84-applicationproperties%EC%97%90%EC%84%9C-%EA%B4%80%EB%A6%AC-%ED%9B%84-%EC%A0%81%EC%9A%A9\" aria-label=\"3 url을 applicationproperties에서 관리 후 적용 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>3. url을 application.properties에서 관리 후 적용</h3>\n<p>url을 하드코딩 하기보다는 프로퍼티에서 관리하는것이 변경이 발생했을때 변경사항을 적용하기 편리하다.</p>\n<p>아래와 같은 방식으로 작성하면 application.properties에서 해당 프로퍼티를 읽어온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"token-client\"</span><span class=\"token punctuation\">,</span> url <span class=\"token operator\">=</span> <span class=\"token string\">\"${oauth.kakao.service.token_url}\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">OAuthTokenClient</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"-마무리\" style=\"position:relative;\"><a href=\"#-%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\" 마무리 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>💫 마무리</h2>\n<p>이번에 FeignClient를 어노테이션만으로 요청에 필요한 모든 설정을 마칠 수 있다는 점에서 이전에 RestTemplate, WebClient를 사용했을때와 비교해 너무 간편하다는 느낌을 받았다.\n물론 추가적인 설정 없이는 비동기적으로 동작하지 않기에 WebClient를 대체할 수는 없지만 특별히 비동기적인 동작이 필요없다면 FeignClient를 사용하지 않을까 싶다.</p>\n<p>또한 WireMock을 함께 사용하면 테스트도 쉽게 할 수 있는데 이 내용은 다음 글에서 이어서 작성하려고 한다.</p>","frontmatter":{"title":"프로젝트에 Feign Client를 적용해보자","date":"August 13, 2022","update":null,"tags":["project","spring"],"series":"식도락 프로젝트 개발기"},"fields":{"slug":"/feign-client/","readingTime":{"minutes":10.435}}},"seriesList":{"edges":[{"node":{"id":"8f11182d-6515-5925-aa77-12b91f24423c","fields":{"slug":"/feign-client/"},"frontmatter":{"title":"프로젝트에 Feign Client를 적용해보자"}}},{"node":{"id":"7fc36caa-34d5-5cfc-97ee-ad38240a5639","fields":{"slug":"/wiremock/"},"frontmatter":{"title":"테스트에서 Wiremock을 이용해서 외부 의존성 줄이기"}}},{"node":{"id":"9d3185ca-d585-51ce-a6ce-ff5920cbcb96","fields":{"slug":"/offset-nooffest/"},"frontmatter":{"title":"offset과 no offset을 사용한 페이징 성능 차이 분석"}}},{"node":{"id":"ba095530-9598-5162-ab5c-a38f1435c4b6","fields":{"slug":"/oauth-refactoring/"},"frontmatter":{"title":"여러 플랫폼에 대응할 수 있는 OAuth 코드로 개선하기"}}}]},"previous":{"fields":{"slug":"/codesquad/"},"frontmatter":{"title":"2022년 코드스쿼드 회고"}},"next":{"fields":{"slug":"/wiremock/"},"frontmatter":{"title":"테스트에서 Wiremock을 이용해서 외부 의존성 줄이기"}}},"pageContext":{"id":"8f11182d-6515-5925-aa77-12b91f24423c","series":"식도락 프로젝트 개발기","previousPostId":"332076a5-e3ab-50c3-8d58-d10b0b5cd5b3","nextPostId":"7fc36caa-34d5-5cfc-97ee-ad38240a5639"}},"staticQueryHashes":[],"slicesMap":{}}